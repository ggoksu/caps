#
# Backup Pivotal Container Service
#

- type: replace
  path: /resources/-
  value:
    name: backup-pks-timestamp
    type: keyval

- type: replace
  path: /jobs/-
  value:
    name: backup-pks
    serial: true
    serial_groups: [pas]
    on_failure:
      do:
      - task: notify on backup-pks failure
    plan:
    - aggregate:
      - get: automation
      - get: schedule
        passed: [backup-regulator]
        trigger: true

    - task: prepare-backup
      privileged: true
      file: automation/lib/pipelines/pcf/backup-and-restore/tasks/prepare-opsman-backup/task.yml
      params: 
        TRACE: ((trace))
        SSH_KEY: ((ssh_key))
        OPSMAN_HOST: ((opsman_host))
        OPSMAN_USERNAME: ((opsman_username))
        OPSMAN_PASSWORD: ((opsman_password))
        OPSMAN_SSH_USER: ((opsman_ssh_user))
        OPSMAN_SSH_PASSWD: ((opsman_ssh_passwd))
        OPSMAN_DECRYPTION_KEY: ((opsman_pass_phrase))
        OPSMAN_CLIENT_ID: ((pcfops_client))
        OPSMAN_CLIENT_SECRET: ((pcfops_secret))

        ## Backup storage backend type should be one of 'scp', 's3', 'gcs', 'swift'
        BACKUP_TYPE: ((backup_storage_type))
        BACKUP_TARGET: ((backup_target))/pks
        
        ## Credentials for GCS access
        GCP_SERVICE_ACCOUNT_KEY: ((gcp_service_account_key))
        GCS_BUCKET_NAME: ((gcs_bucket_name))

        ## GCS mount path
        GCS_MOUNT: ((gcs_mount))

    - task: backup-pks-tile
      privileged: true
      file: automation/lib/tasks/bbr/backup-pks/task.yml
      params: 
        TRACE: ((trace))
        SSH_KEY: ((ssh_key))

        ## Backup storage backend type should be one of 'scp', 's3', 'gcs', 'swift'
        BACKUP_TYPE: ((backup_storage_type))
        BACKUP_TARGET: ((backup_target))/pks
        
        ## Credentials for GCS access
        GCP_SERVICE_ACCOUNT_KEY: ((gcp_service_account_key))
        GCS_BUCKET_NAME: ((gcs_bucket_name))

        ## GCS mount path
        GCS_MOUNT: ((gcs_mount))

    - task: cleanup
      privileged: true
      file: automation/lib/tasks/bbr/cleanup/task.yml
      params: 
        TRACE: ((trace))
        SSH_KEY: ((ssh_key))
        OPSMAN_HOST: ((opsman_host))
        OPSMAN_USERNAME: ((opsman_username))
        OPSMAN_PASSWORD: ((opsman_password))
        OPSMAN_SSH_USER: ((opsman_ssh_user))
        OPSMAN_SSH_PASSWD: ((opsman_ssh_passwd))
        OPSMAN_DECRYPTION_KEY: ((opsman_pass_phrase))
        OPSMAN_CLIENT_ID: ((pcfops_client))
        OPSMAN_CLIENT_SECRET: ((pcfops_secret))

        ## Backup storage backend type should be one of 'scp', 's3', 'gcs', 'swift'
        BACKUP_TYPE: ((backup_storage_type))
        BACKUP_TARGET: ((backup_target))/pks
        
        ## Credentials for GCS access
        GCP_SERVICE_ACCOUNT_KEY: ((gcp_service_account_key))
        GCS_BUCKET_NAME: ((gcs_bucket_name))

        ## GCS mount path
        GCS_MOUNT: ((gcs_mount))

    - put: backup-pks-timestamp
      params:
        file: backup-timestamp/metadata

#
# Restore Pivotal Application Service
#

- type: replace
  path: /jobs/-
  value:
    name: restore-pks
    serial: true
    serial_groups: [pas]
    on_failure:
      do:
      - task: notify on restore-pks failure
    plan:
    - aggregate:
      - get: automation
      - get: backup-pks-timestamp
        passed: [backup-pks]

    - task: prepare-restore
      privileged: true
      file: automation/lib/pipelines/pcf/backup-and-restore/tasks/prepare-opsman-restore/task.yml
      params: 
        TRACE: ((trace))
        SSH_KEY: ((ssh_key))
        OPSMAN_HOST: ((opsman_host))
        OPSMAN_USERNAME: ((opsman_username))
        OPSMAN_PASSWORD: ((opsman_password))
        OPSMAN_SSH_USER: ((opsman_ssh_user))
        OPSMAN_SSH_PASSWD: ((opsman_ssh_passwd))
        OPSMAN_DECRYPTION_KEY: ((opsman_pass_phrase))
        OPSMAN_CLIENT_ID: ((pcfops_client))
        OPSMAN_CLIENT_SECRET: ((pcfops_secret))

        ## Backup storage backend type should be one of 'scp', 's3', 'gcs', 'swift'
        BACKUP_TYPE: ((backup_storage_type))
        BACKUP_TARGET: ((backup_target))/pks
        
        ## Credentials for GCS access
        GCP_SERVICE_ACCOUNT_KEY: ((gcp_service_account_key))
        GCS_BUCKET_NAME: ((gcs_bucket_name))

        ## GCS mount path
        GCS_MOUNT: ((gcs_mount))

    - task: restore-pks
      privileged: true
      file: automation/lib/tasks/bbr/restore-pks/task.yml
      params: 
        TRACE: ((trace))
        SSH_KEY: ((ssh_key))

        ## Backup storage backend type should be one of 'scp', 's3', 'gcs', 'swift'
        BACKUP_TYPE: ((backup_storage_type))
        BACKUP_TARGET: ((backup_target))/pks
        
        ## Credentials for GCS access
        GCP_SERVICE_ACCOUNT_KEY: ((gcp_service_account_key))
        GCS_BUCKET_NAME: ((gcs_bucket_name))

        ## GCS mount path
        GCS_MOUNT: ((gcs_mount))
