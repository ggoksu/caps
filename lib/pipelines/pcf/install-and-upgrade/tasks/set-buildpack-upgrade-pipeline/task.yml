---
platform: linux

image_resource:
  type: docker-image
  source:
    repository: appbricks/automation-tools

inputs:
- name: automation
- name: terraform-output

run:
  path: automation/lib/pipelines/pcf/install-and-upgrade/tasks/set-buildpack-upgrade-pipeline/task.sh

params:
  TRACE: Y
  
  CONCOURSE_URL:
  CONCOURSE_USER:
  CONCOURSE_PASSWORD:
  AUTOS3_URL:
  AUTOS3_ACCESS_KEY:
  AUTOS3_SECRET_KEY:
  ENVIRONMENT:
  PIVNET_TOKEN:
  OPSMAN_HOST:
  OPSMAN_USERNAME:
  OPSMAN_PASSWORD:

# - type: replace
#   path: /jobs/-
#   value:
#     name: post-deploy-${product_name}-tile
#     serial_groups: [opsman]
#     on_failure:
#       do:
#       - task: notify on post-deploy-${product_name}-tile failure

#     plan:
#     - aggregate:
#       - get: automation
#       - get: terraform-output
#       - get: pivnet-product
#         resource: ${product_name}-tile
#         passed: [deploy]
#         trigger: true
#         params: { globs: [] }

#     # Set buildpack upgrade pipeline
#     - task: set-buildpack-upgrade-pipeline
#       file: automation/lib/pipelines/pcf/install-and-upgrade/tasks/set-buildpack-upgrade-pipeline/task.yml
#       params:
#         CONCOURSE_URL: ((concourse_url))
#         CONCOURSE_USER: ((concourse_user))
#         CONCOURSE_PASSWORD: ((concourse_password))
#         AUTOS3_URL: ((autos3_url))
#         AUTOS3_ACCESS_KEY: ((autos3_access_key))
#         AUTOS3_SECRET_KEY: ((autos3_secret_key))
#         ENVIRONMENT: ((environment))
#         PIVNET_TOKEN: ((pivnet_token))
#         OPSMAN_HOST: ((opsman_host))
#         OPSMAN_CLIENT_ID: ((opsman_client_id))
#         OPSMAN_CLIENT_SECRET: ((opsman_client_secret))
#         OPSMAN_USERNAME: ((opsman_admin_username))
#         OPSMAN_PASSWORD: ((opsman_admin_password))

