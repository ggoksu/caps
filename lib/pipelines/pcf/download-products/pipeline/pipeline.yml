---
resource_types:

- name: pivnet
  type: docker-image
  source:
    repository: pivotalcf/pivnet-resource
    tag: latest-final

resources:
- name: automation
  type: git
  source:
    uri: ((automation_pipelines_repo))
    branch: ((automation_pipelines_branch))

- name: schedule
  type: time
  source:
    interval: 30m
    start: "12:00 AM"
    stop: "11:59 PM"
    location: America/Los_Angeles
    days: [Sunday, Monday, Tuesday, Wednesday, Thursday, Friday, Saturday]

- name: ops-manager-download
  type: pivnet
  source:
    api_token: ((pivnet_token))
    product_slug: ops-manager
    product_version: ((opsman_major_minor_version))
    sort_by: semver

jobs:

- name: ops-manager-download-regulator
  plan:
  - get: schedule
    trigger: true
  - get: ops-manager-download
    params: {globs: []}

- name: download-ops-manager
  on_failure:
    do:
    - task: notify on download-ops-manager failure

  serial: true
  plan:
  - aggregate:
    - get: automation
    - get: pivnet-product 
      resource: ops-manager-download
      passed: [ops-manager-download-regulator]
      trigger: true
      params:
        globs:
        - '*GCP.yml'

  # Download product tile and its stemcell to local repository
  - task: download-to-local-repo
    file: automation/lib/tasks/opsman/download-product/task.yml
    params:
      IAAS: ((iaas_type))
      OPSMAN_HOST: ((opsman_host))
      OPSMAN_CLIENT_ID: ((opsman_client_id))
      OPSMAN_CLIENT_SECRET: ((opsman_client_secret))
      OPSMAN_USERNAME: ((opsman_admin_username))
      OPSMAN_PASSWORD: ((opsman_admin_password))
      PIVNET_API_TOKEN: ((pivnet_token))
      AUTOS3_URL: ((autos3_url))
      AUTOS3_ACCESS_KEY: ((autos3_access_key))
      AUTOS3_SECRET_KEY: ((autos3_secret_key))
      BUCKET: pcf
